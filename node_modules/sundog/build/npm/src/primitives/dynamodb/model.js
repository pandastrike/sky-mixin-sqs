"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _pandaParchment = require("panda-parchment");

var _types = require("./helpers/types");

var _expressions = require("./helpers/expressions");

var _items = _interopRequireDefault(require("./items"));

var _queries = _interopRequireDefault(require("./queries"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var DynamoDB;

DynamoDB = function (db) {
  var Model, deleteItem, getItem, putItem, query, updateItem;
  ({
    get: getItem,
    put: putItem,
    del: deleteItem,
    update: updateItem
  } = (0, _items.default)(db));
  ({
    query
  } = (0, _queries.default)(db));

  Model = function (definition) {
    var decrement, del, get, getKey, increment, parse, put, queryIndex, queryTable, table, update, updateEx, wrap;
    ({
      table
    } = definition);
    parse = (0, _types.parse)(definition.types);
    wrap = (0, _types.wrap)(definition.types);
    getKey = (0, _types.getKey)(definition);
    updateEx = (0, _expressions.updateEx)(definition); // default interface for the model. "key" is allowed to be just the key or the whole data object

    get = async function (key) {
      var item;
      item = await getItem(table, getKey(key));

      if (item != null) {
        return parse(item);
      } else {
        return false;
      }
    };

    put = async function (data) {
      return await putItem(table, wrap(data));
    };

    del = async function (key) {
      return await deleteItem(table, getKey(key));
    };

    update = async function (key, data, drop) {
      return await updateItem(table, getKey(key), updateEx(data) + (0, _expressions.dropEx)(drop));
    }; // "key" is allowed to be just the key or the whole data object


    increment = async function (key, field) {
      return await updateItem(table, getKey(key), (0, _expressions.numberEx)(field, 1));
    };

    decrement = async function (key, field) {
      return await updateItem(table, getKey(key), (0, _expressions.numberEx)(field, -1));
    }; // Query interface for this table and its GSIs.


    queryTable = async function (keyEx, filterEx, options) {
      return await query(table, keyEx, filterEx, options);
    };

    queryIndex = async function (index, keyEx, filterEx, options) {
      return await query(`${table}:${index}`, keyEx, filterEx, options);
    };

    return {
      parse,
      wrap,
      getKey,
      get,
      put,
      del,
      update,
      increment,
      decrement,
      queryTable,
      queryIndex
    };
  };

  return {
    Model
  };
};

var _default = DynamoDB;
exports.default = _default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZC9yZXBvcy9zdW5kb2cvc3JjL3ByaW1pdGl2ZXMvZHluYW1vZGIvbW9kZWwuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUpBLElBQUEsUUFBQTs7QUFNQSxRQUFBLEdBQVcsVUFBQSxFQUFBLEVBQUE7QUFDVCxNQUFBLEtBQUEsRUFBQSxVQUFBLEVBQUEsT0FBQSxFQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsVUFBQTtBQUFBLEdBQUE7QUFBQyxJQUFBLEdBQUEsRUFBRCxPQUFBO0FBQWUsSUFBQSxHQUFBLEVBQWYsT0FBQTtBQUE0QixJQUFBLEdBQUEsRUFBNUIsVUFBQTtBQUE0QyxJQUFBLE1BQUEsRUFBTztBQUFuRCxNQUFpRSxvQkFBakUsRUFBaUUsQ0FBakU7QUFDQSxHQUFBO0FBQUEsSUFBQTtBQUFBLE1BQVUsc0JBQVYsRUFBVSxDQUFWOztBQUVBLEVBQUEsS0FBQSxHQUFRLFVBQUEsVUFBQSxFQUFBO0FBQ04sUUFBQSxTQUFBLEVBQUEsR0FBQSxFQUFBLEdBQUEsRUFBQSxNQUFBLEVBQUEsU0FBQSxFQUFBLEtBQUEsRUFBQSxHQUFBLEVBQUEsVUFBQSxFQUFBLFVBQUEsRUFBQSxLQUFBLEVBQUEsTUFBQSxFQUFBLFFBQUEsRUFBQSxJQUFBO0FBQUEsS0FBQTtBQUFBLE1BQUE7QUFBQSxRQUFBLFVBQUE7QUFDQSxJQUFBLEtBQUEsR0FBUSxrQkFBTyxVQUFVLENBQWpCLEtBQUEsQ0FBUjtBQUNBLElBQUEsSUFBQSxHQUFPLGlCQUFNLFVBQVUsQ0FBaEIsS0FBQSxDQUFQO0FBQ0EsSUFBQSxNQUFBLEdBQVMsbUJBQUEsVUFBQSxDQUFUO0FBQ0EsSUFBQSxRQUFBLEdBQVcsMkJBSlgsVUFJVyxDQUFYLENBTE0sQzs7QUFRTixJQUFBLEdBQUEsR0FBTSxnQkFBQSxHQUFBLEVBQUE7QUFDSixVQUFBLElBQUE7QUFBQSxNQUFBLElBQUEsR0FBTyxNQUFNLE9BQUEsQ0FBQSxLQUFBLEVBQWUsTUFBQSxDQUFyQixHQUFxQixDQUFmLENBQWI7O0FBQ0EsVUFBRyxJQUFBLElBQUgsSUFBQSxFQUFBO2VBQWMsS0FBQSxDQUFkLElBQWMsQztBQUFkLE9BQUEsTUFBQTtlQUFBLEs7O0FBRkksS0FBTjs7QUFHQSxJQUFBLEdBQUEsR0FBTSxnQkFBQSxJQUFBLEVBQUE7QUFDSixhQUFBLE1BQU0sT0FBQSxDQUFBLEtBQUEsRUFBZSxJQUFBLENBQXJCLElBQXFCLENBQWYsQ0FBTjtBQURJLEtBQU47O0FBRUEsSUFBQSxHQUFBLEdBQU0sZ0JBQUEsR0FBQSxFQUFBO0FBQ0osYUFBQSxNQUFNLFVBQUEsQ0FBQSxLQUFBLEVBQWtCLE1BQUEsQ0FBeEIsR0FBd0IsQ0FBbEIsQ0FBTjtBQURJLEtBQU47O0FBRUEsSUFBQSxNQUFBLEdBQVMsZ0JBQUEsR0FBQSxFQUFBLElBQUEsRUFBQSxJQUFBLEVBQUE7QUFDUCxhQUFBLE1BQU0sVUFBQSxDQUFBLEtBQUEsRUFBbUIsTUFBQSxDQUFuQixHQUFtQixDQUFuQixFQUFpQyxRQUFBLENBQUQsSUFBQyxDQUFELEdBQW1CLHlCQUF6RCxJQUF5RCxDQUFuRCxDQUFOO0FBZkYsS0FjQSxDQWZNLEM7OztBQW1CTixJQUFBLFNBQUEsR0FBWSxnQkFBQSxHQUFBLEVBQUEsS0FBQSxFQUFBO0FBQ1YsYUFBQSxNQUFNLFVBQUEsQ0FBQSxLQUFBLEVBQW1CLE1BQUEsQ0FBbkIsR0FBbUIsQ0FBbkIsRUFBaUMsMkJBQUEsS0FBQSxFQUF2QyxDQUF1QyxDQUFqQyxDQUFOO0FBRFUsS0FBWjs7QUFFQSxJQUFBLFNBQUEsR0FBWSxnQkFBQSxHQUFBLEVBQUEsS0FBQSxFQUFBO0FBQ1YsYUFBQSxNQUFNLFVBQUEsQ0FBQSxLQUFBLEVBQW1CLE1BQUEsQ0FBbkIsR0FBbUIsQ0FBbkIsRUFBaUMsMkJBQUEsS0FBQSxFQUFnQixDQUF2RCxDQUF1QyxDQUFqQyxDQUFOO0FBckJGLEtBb0JBLENBckJNLEM7OztBQXlCTixJQUFBLFVBQUEsR0FBYSxnQkFBQSxLQUFBLEVBQUEsUUFBQSxFQUFBLE9BQUEsRUFBQTtBQUNYLGFBQUEsTUFBTSxLQUFBLENBQUEsS0FBQSxFQUFBLEtBQUEsRUFBQSxRQUFBLEVBQU4sT0FBTSxDQUFOO0FBRFcsS0FBYjs7QUFFQSxJQUFBLFVBQUEsR0FBYSxnQkFBQSxLQUFBLEVBQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxPQUFBLEVBQUE7QUFDWCxhQUFBLE1BQU0sS0FBQSxDQUFNLEdBQUEsS0FBQSxJQUFBLEtBQU4sRUFBQSxFQUFBLEtBQUEsRUFBQSxRQUFBLEVBQU4sT0FBTSxDQUFOO0FBRFcsS0FBYjs7V0FJQTtBQUFBLE1BQUEsS0FBQTtBQUFBLE1BQUEsSUFBQTtBQUFBLE1BQUEsTUFBQTtBQUFBLE1BQUEsR0FBQTtBQUFBLE1BQUEsR0FBQTtBQUFBLE1BQUEsR0FBQTtBQUFBLE1BQUEsTUFBQTtBQUFBLE1BQUEsU0FBQTtBQUFBLE1BQUEsU0FBQTtBQUFBLE1BQUEsVUFBQTtBQUFBLE1BQUE7QUFBQSxLO0FBL0JNLEdBQVI7O1NBc0NBO0FBQUEsSUFBQTtBQUFBLEc7QUExQ1MsQ0FBWDs7ZUE0Q2UsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZW1wdHksIGZpcnN0LCBzZWNvbmR9IGZyb20gXCJwYW5kYS1wYXJjaG1lbnRcIlxuaW1wb3J0IHt0bywgd3JhcCBhcyBfd3JhcCwgcGFyc2UgYXMgX3BhcnNlLCBnZXRLZXkgYXMgX2dldEtleX0gZnJvbSBcIi4vaGVscGVycy90eXBlc1wiXG5pbXBvcnQge251bWJlckV4LCB1cGRhdGVFeCBhcyBfdXBkYXRlRXgsIGRyb3BFeCwgcXZ9IGZyb20gXCIuL2hlbHBlcnMvZXhwcmVzc2lvbnNcIlxuaW1wb3J0IEl0ZW1zIGZyb20gXCIuL2l0ZW1zXCJcbmltcG9ydCBRdWVyaWVzIGZyb20gXCIuL3F1ZXJpZXNcIlxuXG5EeW5hbW9EQiA9IChkYikgLT5cbiAge2dldDogZ2V0SXRlbSwgcHV0OnB1dEl0ZW0sIGRlbDpkZWxldGVJdGVtLCB1cGRhdGU6dXBkYXRlSXRlbX0gPSBJdGVtcyBkYlxuICB7cXVlcnl9ID0gUXVlcmllcyBkYlxuXG4gIE1vZGVsID0gKGRlZmluaXRpb24pIC0+XG4gICAge3RhYmxlfSA9IGRlZmluaXRpb25cbiAgICBwYXJzZSA9IF9wYXJzZSBkZWZpbml0aW9uLnR5cGVzXG4gICAgd3JhcCA9IF93cmFwIGRlZmluaXRpb24udHlwZXNcbiAgICBnZXRLZXkgPSBfZ2V0S2V5IGRlZmluaXRpb25cbiAgICB1cGRhdGVFeCA9IF91cGRhdGVFeCBkZWZpbml0aW9uXG5cbiAgICAjIGRlZmF1bHQgaW50ZXJmYWNlIGZvciB0aGUgbW9kZWwuIFwia2V5XCIgaXMgYWxsb3dlZCB0byBiZSBqdXN0IHRoZSBrZXkgb3IgdGhlIHdob2xlIGRhdGEgb2JqZWN0XG4gICAgZ2V0ID0gKGtleSkgLT5cbiAgICAgIGl0ZW0gPSBhd2FpdCBnZXRJdGVtIHRhYmxlLCBnZXRLZXkga2V5XG4gICAgICBpZiBpdGVtPyB0aGVuIHBhcnNlIGl0ZW0gZWxzZSBmYWxzZVxuICAgIHB1dCA9IChkYXRhKSAtPlxuICAgICAgYXdhaXQgcHV0SXRlbSB0YWJsZSwgd3JhcCBkYXRhXG4gICAgZGVsID0gKGtleSkgLT5cbiAgICAgIGF3YWl0IGRlbGV0ZUl0ZW0gdGFibGUsIGdldEtleSBrZXlcbiAgICB1cGRhdGUgPSAoa2V5LCBkYXRhLCBkcm9wKSAtPlxuICAgICAgYXdhaXQgdXBkYXRlSXRlbSB0YWJsZSwgKGdldEtleSBrZXkpLCAodXBkYXRlRXggZGF0YSkgKyAoZHJvcEV4IGRyb3ApXG5cbiAgICAjIFwia2V5XCIgaXMgYWxsb3dlZCB0byBiZSBqdXN0IHRoZSBrZXkgb3IgdGhlIHdob2xlIGRhdGEgb2JqZWN0XG4gICAgaW5jcmVtZW50ID0gKGtleSwgZmllbGQpIC0+XG4gICAgICBhd2FpdCB1cGRhdGVJdGVtIHRhYmxlLCAoZ2V0S2V5IGtleSksIChudW1iZXJFeCBmaWVsZCwgMSlcbiAgICBkZWNyZW1lbnQgPSAoa2V5LCBmaWVsZCkgLT5cbiAgICAgIGF3YWl0IHVwZGF0ZUl0ZW0gdGFibGUsIChnZXRLZXkga2V5KSwgKG51bWJlckV4IGZpZWxkLCAtMSlcblxuICAgICMgUXVlcnkgaW50ZXJmYWNlIGZvciB0aGlzIHRhYmxlIGFuZCBpdHMgR1NJcy5cbiAgICBxdWVyeVRhYmxlID0gKGtleUV4LCBmaWx0ZXJFeCwgb3B0aW9ucykgLT5cbiAgICAgIGF3YWl0IHF1ZXJ5IHRhYmxlLCBrZXlFeCwgZmlsdGVyRXgsIG9wdGlvbnNcbiAgICBxdWVyeUluZGV4ID0gKGluZGV4LCBrZXlFeCwgZmlsdGVyRXgsIG9wdGlvbnMpIC0+XG4gICAgICBhd2FpdCBxdWVyeSBcIiN7dGFibGV9OiN7aW5kZXh9XCIsIGtleUV4LCBmaWx0ZXJFeCwgb3B0aW9uc1xuXG5cbiAgICB7XG4gICAgICBwYXJzZSwgd3JhcCwgZ2V0S2V5XG4gICAgICBnZXQsIHB1dCwgZGVsLCB1cGRhdGUsXG4gICAgICBpbmNyZW1lbnQsIGRlY3JlbWVudCxcbiAgICAgIHF1ZXJ5VGFibGUsIHF1ZXJ5SW5kZXhcbiAgICB9XG5cbiAge01vZGVsfVxuXG5leHBvcnQgZGVmYXVsdCBEeW5hbW9EQlxuIl0sInNvdXJjZVJvb3QiOiIifQ==
//# sourceURL=/Users/david/repos/sundog/src/primitives/dynamodb/model.coffee