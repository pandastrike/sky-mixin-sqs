"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _pandaParchment = require("panda-parchment");

var _expressions = require("./helpers/expressions");

//===========================================================================
// Queries and Scans against Tables and Indexes
//===========================================================================
var DynamoDB, _parseName, _parseQuery;

_parseName = function (name) {
  var parts;

  if (!name) {
    throw new Error("Must provide table name.");
  }

  parts = name.split(":");

  if (parts.length > 1) {
    return {
      tableName: parts[0],
      indexName: parts[1]
    };
  } else {
    return {
      tableName: name,
      indexName: false
    };
  }
};

_parseQuery = function (options, name, keyEx, filterEx) {
  var count, filter, filterValues, indexName, key, keyValues, tableName;
  ({
    tableName,
    indexName
  } = _parseName(name));
  ({
    result: key,
    values: keyValues,
    count
  } = (0, _expressions.parseConditional)(keyEx));
  ({
    result: filter,
    values: filterValues
  } = (0, _expressions.parseConditional)(filterEx, count));
  options.TableName = tableName;

  if (indexName) {
    options.IndexName = indexName;
  }

  if (key) {
    options.KeyConditionExpression = key;
  }

  if (filter) {
    options.FilterExpression = filter;
  }

  if (keyValues || filterValues) {
    options.ExpressionAttributeValues = (0, _pandaParchment.merge)(keyValues || {}, filterValues || {});
  }

  return options;
};

DynamoDB = function (db) {
  var query, scan;

  query = async function (name, keyEx, filterEx, options = {}) {
    // _parseQuery augments any input options with request parameters
    options = _parseQuery(options, name, keyEx, filterEx);
    return await db.query(options);
  };

  scan = async function (name, filterEx, options = {}) {
    options = _parseQuery(options, name, false, filterEx);
    return await db.scan(options);
  };

  return {
    query,
    scan
  };
};

var _default = DynamoDB;
exports.default = _default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZC9yZXBvcy9zdW5kb2cvc3JjL3ByaW1pdGl2ZXMvZHluYW1vZGIvcXVlcmllcy5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUdBOztBQUNBOztBQUpBOzs7QUFBQSxJQUFBLFFBQUEsRUFBQSxVQUFBLEVBQUEsV0FBQTs7QUFNQSxVQUFBLEdBQWEsVUFBQSxJQUFBLEVBQUE7QUFDWCxNQUFBLEtBQUE7O0FBQUEsTUFBOEMsQ0FBOUMsSUFBQSxFQUFBO0FBQUEsVUFBTSxJQUFBLEtBQUEsQ0FBTiwwQkFBTSxDQUFOOzs7QUFDQSxFQUFBLEtBQUEsR0FBUSxJQUFJLENBQUosS0FBQSxDQUFBLEdBQUEsQ0FBUjs7QUFDQSxNQUFHLEtBQUssQ0FBTCxNQUFBLEdBQUgsQ0FBQSxFQUFBO1dBQ0U7QUFBQyxNQUFBLFNBQUEsRUFBVyxLQUFNLENBQWxCLENBQWtCLENBQWxCO0FBQXNCLE1BQUEsU0FBQSxFQUFXLEtBQU0sQ0FBQSxDQUFBO0FBQXZDLEs7QUFERixHQUFBLE1BQUE7V0FHRTtBQUFDLE1BQUEsU0FBQSxFQUFELElBQUE7QUFBa0IsTUFBQSxTQUFBLEVBQVc7QUFBN0IsSzs7QUFOUyxDQUFiOztBQVFBLFdBQUEsR0FBYyxVQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsS0FBQSxFQUFBLFFBQUEsRUFBQTtBQUNaLE1BQUEsS0FBQSxFQUFBLE1BQUEsRUFBQSxZQUFBLEVBQUEsU0FBQSxFQUFBLEdBQUEsRUFBQSxTQUFBLEVBQUEsU0FBQTtBQUFBLEdBQUE7QUFBQSxJQUFBLFNBQUE7QUFBQSxJQUFBO0FBQUEsTUFBeUIsVUFBQSxDQUF6QixJQUF5QixDQUF6QjtBQUNBLEdBQUE7QUFBQyxJQUFBLE1BQUEsRUFBRCxHQUFBO0FBQWEsSUFBQSxNQUFBLEVBQWIsU0FBQTtBQUErQixJQUFBO0FBQS9CLE1BQXdDLG1DQUF4QyxLQUF3QyxDQUF4QztBQUNBLEdBQUE7QUFBQyxJQUFBLE1BQUEsRUFBRCxNQUFBO0FBQWdCLElBQUEsTUFBQSxFQUFPO0FBQXZCLE1BQXVDLG1DQUFBLFFBQUEsRUFBdkMsS0FBdUMsQ0FBdkM7QUFFQSxFQUFBLE9BQU8sQ0FBUCxTQUFBLEdBQW9CLFNBQXBCOztBQUNBLE1BQUEsU0FBQSxFQUFBO0FBQUEsSUFBQSxPQUFPLENBQVAsU0FBQSxHQUFBLFNBQUE7OztBQUNBLE1BQUEsR0FBQSxFQUFBO0FBQUEsSUFBQSxPQUFPLENBQVAsc0JBQUEsR0FBQSxHQUFBOzs7QUFDQSxNQUFBLE1BQUEsRUFBQTtBQUFBLElBQUEsT0FBTyxDQUFQLGdCQUFBLEdBQUEsTUFBQTs7O0FBQ0EsTUFBRyxTQUFBLElBQUgsWUFBQSxFQUFBO0FBQ0UsSUFBQSxPQUFPLENBQVAseUJBQUEsR0FDRSwyQkFBTyxTQUFBLElBQVAsRUFBQSxFQUEwQixZQUFBLElBRjlCLEVBRUksQ0FERjs7O1NBRUYsTztBQVpZLENBQWQ7O0FBZUEsUUFBQSxHQUFXLFVBQUEsRUFBQSxFQUFBO0FBQ1QsTUFBQSxLQUFBLEVBQUEsSUFBQTs7QUFBQSxFQUFBLEtBQUEsR0FBUSxnQkFBQSxJQUFBLEVBQUEsS0FBQSxFQUFBLFFBQUEsRUFBd0IsT0FBQSxHQUF4QixFQUFBLEVBQUE7O0FBRU4sSUFBQSxPQUFBLEdBQVUsV0FBQSxDQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsS0FBQSxFQUFBLFFBQUEsQ0FBVjtBQUNBLFdBQUEsTUFBTSxFQUFFLENBQUYsS0FBQSxDQUFOLE9BQU0sQ0FBTjtBQUhNLEdBQVI7O0FBS0EsRUFBQSxJQUFBLEdBQU8sZ0JBQUEsSUFBQSxFQUFBLFFBQUEsRUFBaUIsT0FBQSxHQUFqQixFQUFBLEVBQUE7QUFDTCxJQUFBLE9BQUEsR0FBVSxXQUFBLENBQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxLQUFBLEVBQUEsUUFBQSxDQUFWO0FBQ0EsV0FBQSxNQUFNLEVBQUUsQ0FBRixJQUFBLENBQU4sT0FBTSxDQUFOO0FBRkssR0FBUDs7U0FJQTtBQUFBLElBQUEsS0FBQTtBQUFBLElBQUE7QUFBQSxHO0FBVlMsQ0FBWDs7ZUFZZSxRIiwic291cmNlc0NvbnRlbnQiOlsiIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuIyBRdWVyaWVzIGFuZCBTY2FucyBhZ2FpbnN0IFRhYmxlcyBhbmQgSW5kZXhlc1xuIz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuaW1wb3J0IHtjYXQsIG1lcmdlLCBmaXJzdCwgdmFsdWVzfSBmcm9tIFwicGFuZGEtcGFyY2htZW50XCJcbmltcG9ydCB7cGFyc2VDb25kaXRpb25hbH0gZnJvbSBcIi4vaGVscGVycy9leHByZXNzaW9uc1wiXG5cbl9wYXJzZU5hbWUgPSAobmFtZSkgLT5cbiAgdGhyb3cgbmV3IEVycm9yIFwiTXVzdCBwcm92aWRlIHRhYmxlIG5hbWUuXCIgaWYgIW5hbWVcbiAgcGFydHMgPSBuYW1lLnNwbGl0IFwiOlwiXG4gIGlmIHBhcnRzLmxlbmd0aCA+IDFcbiAgICB7dGFibGVOYW1lOiBwYXJ0c1swXSwgaW5kZXhOYW1lOiBwYXJ0c1sxXX1cbiAgZWxzZVxuICAgIHt0YWJsZU5hbWU6IG5hbWUsIGluZGV4TmFtZTogZmFsc2V9XG5cbl9wYXJzZVF1ZXJ5ID0gKG9wdGlvbnMsIG5hbWUsIGtleUV4LCBmaWx0ZXJFeCkgLT5cbiAge3RhYmxlTmFtZSwgaW5kZXhOYW1lfSA9IF9wYXJzZU5hbWUgbmFtZVxuICB7cmVzdWx0OmtleSwgdmFsdWVzOmtleVZhbHVlcywgY291bnR9ID0gcGFyc2VDb25kaXRpb25hbCBrZXlFeFxuICB7cmVzdWx0OmZpbHRlciwgdmFsdWVzOmZpbHRlclZhbHVlc30gPSBwYXJzZUNvbmRpdGlvbmFsIGZpbHRlckV4LCBjb3VudFxuXG4gIG9wdGlvbnMuVGFibGVOYW1lID0gdGFibGVOYW1lXG4gIG9wdGlvbnMuSW5kZXhOYW1lID0gaW5kZXhOYW1lIGlmIGluZGV4TmFtZVxuICBvcHRpb25zLktleUNvbmRpdGlvbkV4cHJlc3Npb24gPSBrZXkgaWYga2V5XG4gIG9wdGlvbnMuRmlsdGVyRXhwcmVzc2lvbiA9IGZpbHRlciBpZiBmaWx0ZXJcbiAgaWYga2V5VmFsdWVzIHx8IGZpbHRlclZhbHVlc1xuICAgIG9wdGlvbnMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9XG4gICAgICBtZXJnZSAoa2V5VmFsdWVzIHx8IHt9KSwgKGZpbHRlclZhbHVlcyB8fCB7fSlcbiAgb3B0aW9uc1xuXG5cbkR5bmFtb0RCID0gKGRiKSAtPlxuICBxdWVyeSA9IChuYW1lLCBrZXlFeCwgZmlsdGVyRXgsIG9wdGlvbnM9e30pIC0+XG4gICAgIyBfcGFyc2VRdWVyeSBhdWdtZW50cyBhbnkgaW5wdXQgb3B0aW9ucyB3aXRoIHJlcXVlc3QgcGFyYW1ldGVyc1xuICAgIG9wdGlvbnMgPSBfcGFyc2VRdWVyeSBvcHRpb25zLCBuYW1lLCBrZXlFeCwgZmlsdGVyRXhcbiAgICBhd2FpdCBkYi5xdWVyeSBvcHRpb25zXG5cbiAgc2NhbiA9IChuYW1lLCBmaWx0ZXJFeCwgb3B0aW9ucz17fSkgLT5cbiAgICBvcHRpb25zID0gX3BhcnNlUXVlcnkgb3B0aW9ucywgbmFtZSwgZmFsc2UsIGZpbHRlckV4XG4gICAgYXdhaXQgZGIuc2NhbiBvcHRpb25zXG5cbiAge3F1ZXJ5LCBzY2FufVxuXG5leHBvcnQgZGVmYXVsdCBEeW5hbW9EQlxuIl0sInNvdXJjZVJvb3QiOiIifQ==
//# sourceURL=/Users/david/repos/sundog/src/primitives/dynamodb/queries.coffee