"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _pandaParchment = require("panda-parchment");

var _pandaRiver = require("panda-river");

var _privateUtils = require("../private-utils");

// Primitives for the service S3.  The main entities are buckets and objects.
// This follows the naming convention that methods that work on buckets will be
// prefixed "bucket*", whereas object methods will have no prefix.
var Section;

Section = function (s3, fns) {
  var bucketCreate, bucketDelete, bucketEmpty, bucketExists, bucketHead, bucketSetACL, bucketSetCORS, bucketSetWebsite, bucketTouch, buildCORSRule;

  bucketHead = bucketExists = async function (name) {
    var e;

    try {
      return await s3.headBucket({
        Bucket: name
      });
    } catch (error) {
      e = error;
      return (0, _privateUtils.notFound)(e);
    }
  };

  bucketTouch = async function (name) {
    if (await bucketExists(name)) {
      return true;
    }

    await s3.createBucket({
      Bucket: name
    });
    return await (0, _pandaParchment.sleep)(20000); // race condition with S3 API.  Wait to be available.
  };

  bucketCreate = async function (name, options = {}) {
    return await s3.create((0, _pandaParchment.merge)({
      Bucket: name
    }, options));
  }; // Sets the access control permissions on the whole bucket.


  bucketSetACL = async function (name, value) {
    return await s3.putBucketAcl({
      Bucket: name,
      ACL: value
    });
  };

  buildCORSRule = function ({
    allowedHeaders = ["*"],
    allowedMethods = ["GET"],
    allowedOrigins = ["*"],
    exposedHeaders = [""],
    maxAge
  }) {
    return {
      AllowedHeaders: allowedHeaders,
      AllowedMethods: allowedMethods,
      AllowedOrigins: allowedOrigins,
      ExposeHeaders: exposedHeaders,
      MaxAgeSeconds: maxAge
    };
  }; // Set Cross Origin Resource Sharing (CORS) configuration for the whole bucket.


  bucketSetCORS = async function (name, config) {
    var c, rules;

    if ((0, _pandaParchment.isArray)(config)) {
      rules = function () {
        var i, len, results;
        results = [];

        for (i = 0, len = config.length; i < len; i++) {
          c = config[i];
          results.push(buildCORSRule(c));
        }

        return results;
      }();
    } else {
      rules = [buildCORSRule(config)];
    }

    return await s3.putBucketCors({
      Bucket: name,
      CORSConfiguration: {
        CORSRules: rules
      },
      ContentMD5: ""
    });
  };

  bucketSetWebsite = async function (name, site, redirect) {
    var params, ref;
    params = {
      Bucket: name
    };

    if (site) {
      params.WebsiteConfiguration = {
        IndexDocument: {
          Suffix: site.index
        },
        ErrorDocument: {
          Key: site.error
        }
      };
    } else {
      params.WebsiteConfiguration = {
        RedirectAllRequestsTo: {
          HostName: redirect.host,
          Protocol: (ref = redirect.protocol) != null ? ref : "https"
        }
      };
    }

    return await s3.putBucketWebsite(params);
  };

  bucketDelete = async function (name) {
    var e;

    try {
      return await s3.deleteBucket({
        Bucket: name
      });
    } catch (error) {
      e = error;
      return (0, _privateUtils.notFound)(e);
    }
  }; // TODO: make this more efficient by throttling to X connections at once. AWS
  // only supports N requests per second from an account, and I don't want this
  // to violate that limit, but we can do better than one at a time.


  bucketEmpty = async function (name) {
    var batch, items, keys, ref, results;
    items = await fns.list(name);
    keys = (0, _pandaRiver.collect)((0, _pandaRiver.project)("Key", items));
    ref = (0, _pandaRiver.partition)(1000, keys);
    results = [];

    for (batch of ref) {
      results.push((await fns.deleteBatch(name, batch)));
    }

    return results;
  };

  return {
    bucketExists,
    bucketHead,
    bucketTouch,
    bucketCreate,
    bucketSetACL,
    bucketSetCORS,
    bucketSetWebsite,
    bucketDelete,
    bucketEmpty
  };
};

var _default = Section;
exports.default = _default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9kYXZpZC9yZXBvcy9zdW5kb2cvc3JjL3ByaW1pdGl2ZXMvczMvYnVja2V0LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBTkE7OztBQUFBLElBQUEsT0FBQTs7QUFRQSxPQUFBLEdBQVUsVUFBQSxFQUFBLEVBQUEsR0FBQSxFQUFBO0FBQ1IsTUFBQSxZQUFBLEVBQUEsWUFBQSxFQUFBLFdBQUEsRUFBQSxZQUFBLEVBQUEsVUFBQSxFQUFBLFlBQUEsRUFBQSxhQUFBLEVBQUEsZ0JBQUEsRUFBQSxXQUFBLEVBQUEsYUFBQTs7QUFBQSxFQUFBLFVBQUEsR0FBYSxZQUFBLEdBQWUsZ0JBQUEsSUFBQSxFQUFBO0FBQzFCLFFBQUEsQ0FBQTs7QUFBQSxRQUFBO0FBQ0UsYUFBQSxNQUFNLEVBQUUsQ0FBRixVQUFBLENBQWM7QUFBQSxRQUFBLE1BQUEsRUFBUTtBQUFSLE9BQWQsQ0FBTjtBQURGLEtBQUEsQ0FBQSxPQUFBLEtBQUEsRUFBQTtBQUVNLE1BQUEsQ0FBQSxHQUFBLEtBQUE7YUFDSiw0QkFIRixDQUdFLEM7O0FBSndCLEdBQTVCOztBQU1BLEVBQUEsV0FBQSxHQUFjLGdCQUFBLElBQUEsRUFBQTtBQUNaLFFBQWUsTUFBTSxZQUFBLENBQXJCLElBQXFCLENBQXJCLEVBQUE7QUFBQSxhQUFBLElBQUE7OztBQUNBLFVBQU0sRUFBRSxDQUFGLFlBQUEsQ0FBZ0I7QUFBQyxNQUFBLE1BQUEsRUFBUTtBQUFULEtBQWhCLENBQU47QUFDQSxXQUFBLE1BQU0sMkJBSE0sS0FHTixDQUFOLENBSFksQ0FBQTtBQUFBLEdBQWQ7O0FBS0EsRUFBQSxZQUFBLEdBQWUsZ0JBQUEsSUFBQSxFQUFPLE9BQUEsR0FBUCxFQUFBLEVBQUE7QUFDYixXQUFBLE1BQU0sRUFBRSxDQUFGLE1BQUEsQ0FBVSwyQkFBTTtBQUFDLE1BQUEsTUFBQSxFQUFRO0FBQVQsS0FBTixFQUFoQixPQUFnQixDQUFWLENBQU47QUFa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QUEsS0FBQTthQUNKLDRCQUhGLENBR0UsQzs7QUFsRUosR0E4REEsQ0EvRFEsQzs7Ozs7QUF5RVIsRUFBQSxXQUFBLEdBQWMsZ0JBQUEsSUFBQSxFQUFBO0FBQ1osUUFBQSxLQUFBLEVBQUEsS0FBQSxFQUFBLElBQUEsRUFBQSxHQUFBLEVBQUEsT0FBQTtBQUFBLElBQUEsS0FBQSxHQUFRLE1BQU0sR0FBRyxDQUFILElBQUEsQ0FBTixJQUFNLENBQWQ7QUFDQSxJQUFBLElBQUEsR0FBTyx5QkFBUSx5QkFBQSxLQUFBLEVBQVIsS0FBUSxDQUFSLENBQVA7QUFDa0MsSUFBQSxHQUFBLEdBQUEsMkJBQUEsSUFBQSxFQUFBLElBQUEsQ0FBQTtBQUFBLElBQUEsT0FBQSxHQUFBLEVBQUE7O0FBQUEsU0FBQSxLQUFBLElBQUEsR0FBQSxFQUFBO2NBQWxDLEksRUFBQSxNQUFNLEdBQUcsQ0FBSCxXQUFBLENBQUEsSUFBQSxFQUFOLEtBQU0sQztBQUE0Qjs7O0FBSHRCLEdBQWQ7O1NBT0E7QUFBQSxJQUFBLFlBQUE7QUFBQSxJQUFBLFVBQUE7QUFBQSxJQUFBLFdBQUE7QUFBQSxJQUFBLFlBQUE7QUFBQSxJQUFBLFlBQUE7QUFBQSxJQUFBLGFBQUE7QUFBQSxJQUFBLGdCQUFBO0FBQUEsSUFBQSxZQUFBO0FBQUEsSUFBQTtBQUFBLEc7QUFoRlEsQ0FBVjs7ZUFrRmUsTyIsInNvdXJjZXNDb250ZW50IjpbIiMgUHJpbWl0aXZlcyBmb3IgdGhlIHNlcnZpY2UgUzMuICBUaGUgbWFpbiBlbnRpdGllcyBhcmUgYnVja2V0cyBhbmQgb2JqZWN0cy5cbiMgVGhpcyBmb2xsb3dzIHRoZSBuYW1pbmcgY29udmVudGlvbiB0aGF0IG1ldGhvZHMgdGhhdCB3b3JrIG9uIGJ1Y2tldHMgd2lsbCBiZVxuIyBwcmVmaXhlZCBcImJ1Y2tldCpcIiwgd2hlcmVhcyBvYmplY3QgbWV0aG9kcyB3aWxsIGhhdmUgbm8gcHJlZml4LlxuXG5pbXBvcnQge3NsZWVwLCBtZXJnZSwgaXNBcnJheX0gZnJvbSBcInBhbmRhLXBhcmNobWVudFwiXG5pbXBvcnQge2NvbGxlY3QsIHByb2plY3QsIHBhcnRpdGlvbn0gZnJvbSBcInBhbmRhLXJpdmVyXCJcbmltcG9ydCB7bm90Rm91bmR9IGZyb20gXCIuLi9wcml2YXRlLXV0aWxzXCJcblxuU2VjdGlvbiA9IChzMywgZm5zKSAtPlxuICBidWNrZXRIZWFkID0gYnVja2V0RXhpc3RzID0gKG5hbWUpIC0+XG4gICAgdHJ5XG4gICAgICBhd2FpdCBzMy5oZWFkQnVja2V0IEJ1Y2tldDogbmFtZVxuICAgIGNhdGNoIGVcbiAgICAgIG5vdEZvdW5kIGVcblxuICBidWNrZXRUb3VjaCA9IChuYW1lKSAtPlxuICAgIHJldHVybiB0cnVlIGlmIGF3YWl0IGJ1Y2tldEV4aXN0cyBuYW1lXG4gICAgYXdhaXQgczMuY3JlYXRlQnVja2V0IHtCdWNrZXQ6IG5hbWV9XG4gICAgYXdhaXQgc2xlZXAgMjAwMDAgIyByYWNlIGNvbmRpdGlvbiB3aXRoIFMzIEFQSS4gIFdhaXQgdG8gYmUgYXZhaWxhYmxlLlxuXG4gIGJ1Y2tldENyZWF0ZSA9IChuYW1lLCBvcHRpb25zPXt9KSAtPlxuICAgIGF3YWl0IHMzLmNyZWF0ZSBtZXJnZSB7QnVja2V0OiBuYW1lfSwgb3B0aW9uc1xuXG4gICMgU2V0cyB0aGUgYWNjZXNzIGNvbnRyb2wgcGVybWlzc2lvbnMgb24gdGhlIHdob2xlIGJ1Y2tldC5cbiAgYnVja2V0U2V0QUNMID0gKG5hbWUsIHZhbHVlKSAtPlxuICAgIGF3YWl0IHMzLnB1dEJ1Y2tldEFjbCB7QnVja2V0OiBuYW1lLCBBQ0w6IHZhbHVlfVxuXG4gIGJ1aWxkQ09SU1J1bGUgPSAoe1xuICAgICAgYWxsb3dlZEhlYWRlcnMgPSBbXCIqXCJdLFxuICAgICAgYWxsb3dlZE1ldGhvZHMgPSBbXCJHRVRcIl0sXG4gICAgICBhbGxvd2VkT3JpZ2lucyA9IFtcIipcIl0sXG4gICAgICBleHBvc2VkSGVhZGVycyA9IFtcIlwiXSxcbiAgICAgIG1heEFnZVxuICB9KSAtPlxuICAgIEFsbG93ZWRIZWFkZXJzOiBhbGxvd2VkSGVhZGVyc1xuICAgIEFsbG93ZWRNZXRob2RzOiBhbGxvd2VkTWV0aG9kc1xuICAgIEFsbG93ZWRPcmlnaW5zOiBhbGxvd2VkT3JpZ2luc1xuICAgIEV4cG9zZUhlYWRlcnM6IGV4cG9zZWRIZWFkZXJzXG4gICAgTWF4QWdlU2Vjb25kczogbWF4QWdlXG5cbiAgIyBTZXQgQ3Jvc3MgT3JpZ2luIFJlc291cmNlIFNoYXJpbmcgKENPUlMpIGNvbmZpZ3VyYXRpb24gZm9yIHRoZSB3aG9sZSBidWNrZXQuXG4gIGJ1Y2tldFNldENPUlMgPSAobmFtZSwgY29uZmlnKSAtPlxuICAgIGlmIGlzQXJyYXkgY29uZmlnXG4gICAgICBydWxlcyA9IChidWlsZENPUlNSdWxlIGMgZm9yIGMgaW4gY29uZmlnKVxuICAgIGVsc2VcbiAgICAgIHJ1bGVzID0gWyBidWlsZENPUlNSdWxlIGNvbmZpZyBdXG5cbiAgICBhd2FpdCBzMy5wdXRCdWNrZXRDb3JzXG4gICAgICBCdWNrZXQ6IG5hbWUsXG4gICAgICBDT1JTQ29uZmlndXJhdGlvbjoge0NPUlNSdWxlczogcnVsZXN9XG4gICAgICBDb250ZW50TUQ1OiBcIlwiXG5cbiAgYnVja2V0U2V0V2Vic2l0ZSA9IChuYW1lLCBzaXRlLCByZWRpcmVjdCkgLT5cbiAgICBwYXJhbXMgPVxuICAgICAgQnVja2V0OiBuYW1lXG5cbiAgICBpZiBzaXRlXG4gICAgICBwYXJhbXMuV2Vic2l0ZUNvbmZpZ3VyYXRpb24gPVxuICAgICAgICBJbmRleERvY3VtZW50OlxuICAgICAgICAgIFN1ZmZpeDogc2l0ZS5pbmRleFxuICAgICAgICBFcnJvckRvY3VtZW50OlxuICAgICAgICAgIEtleTogc2l0ZS5lcnJvclxuICAgIGVsc2VcbiAgICAgIHBhcmFtcy5XZWJzaXRlQ29uZmlndXJhdGlvbiA9XG4gICAgICAgIFJlZGlyZWN0QWxsUmVxdWVzdHNUbzpcbiAgICAgICAgICBIb3N0TmFtZTogcmVkaXJlY3QuaG9zdFxuICAgICAgICAgIFByb3RvY29sOiByZWRpcmVjdC5wcm90b2NvbCA/IFwiaHR0cHNcIlxuXG4gICAgYXdhaXQgczMucHV0QnVja2V0V2Vic2l0ZSBwYXJhbXNcblxuXG4gIGJ1Y2tldERlbGV0ZSA9IChuYW1lKSAtPlxuICAgIHRyeVxuICAgICAgYXdhaXQgczMuZGVsZXRlQnVja2V0IEJ1Y2tldDogbmFtZVxuICAgIGNhdGNoIGVcbiAgICAgIG5vdEZvdW5kIGVcblxuXG4gICMgVE9ETzogbWFrZSB0aGlzIG1vcmUgZWZmaWNpZW50IGJ5IHRocm90dGxpbmcgdG8gWCBjb25uZWN0aW9ucyBhdCBvbmNlLiBBV1NcbiAgIyBvbmx5IHN1cHBvcnRzIE4gcmVxdWVzdHMgcGVyIHNlY29uZCBmcm9tIGFuIGFjY291bnQsIGFuZCBJIGRvbid0IHdhbnQgdGhpc1xuICAjIHRvIHZpb2xhdGUgdGhhdCBsaW1pdCwgYnV0IHdlIGNhbiBkbyBiZXR0ZXIgdGhhbiBvbmUgYXQgYSB0aW1lLlxuICBidWNrZXRFbXB0eSA9IChuYW1lKSAtPlxuICAgIGl0ZW1zID0gYXdhaXQgZm5zLmxpc3QgbmFtZVxuICAgIGtleXMgPSBjb2xsZWN0IHByb2plY3QgXCJLZXlcIiwgaXRlbXNcbiAgICBhd2FpdCBmbnMuZGVsZXRlQmF0Y2ggbmFtZSwgYmF0Y2ggZm9yIGJhdGNoIGZyb20gcGFydGl0aW9uIDEwMDAsIGtleXNcblxuXG5cbiAge2J1Y2tldEV4aXN0cywgYnVja2V0SGVhZCwgYnVja2V0VG91Y2gsIGJ1Y2tldENyZWF0ZSwgYnVja2V0U2V0QUNMLCBidWNrZXRTZXRDT1JTLCBidWNrZXRTZXRXZWJzaXRlLCBidWNrZXREZWxldGUsIGJ1Y2tldEVtcHR5fVxuXG5leHBvcnQgZGVmYXVsdCBTZWN0aW9uXG4iXSwic291cmNlUm9vdCI6IiJ9
//# sourceURL=/Users/david/repos/sundog/src/primitives/s3/bucket.coffee